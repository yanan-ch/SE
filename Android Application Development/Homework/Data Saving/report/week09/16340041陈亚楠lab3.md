# 中山大学数据科学与计算机学院本科生实验报告
## （2018年秋季学期）
| 课程名称 | 手机平台应用开发 | 任课老师 | 郑贵锋 |
| :------------: | :-------------: | :------------: | :-------------: |
| 年级 | 2016 | 专业（方向） | 数字媒体 |
| 学号 | 16340041 | 姓名 | 陈亚楠 |
| 电话 | 18709548602 | Email | chenyn97@outlook.com |
| 开始日期 | 2018.11.08 | 完成日期 |2018.11.15|

---

## 一、实验题目

个人项目3 数据存储应用开发 数据存储（一）

---

## 二、实现内容

1.密码输入Activity：

- 若应用首次启动，则界面呈现出两个输入框，分别为新密码输入框和确认密码输入框。 
  
- 输入框下方有两个按钮：  

  - OK按钮点击后：       
    - 若New Password为空，则发出Toast提示。    
		 - 若New Password与Confirm Password不匹配，则发出Toast提示。
		- 若两密码匹配，则保存此密码，并进入文件编辑Activity。

  - CLEAR按钮点击后：清除两输入框的内容。   

- 完成创建密码后，退出应用再进入应用，则只呈现一个密码输入框。
	- 点击OK按钮后，若输入的密码与之前的密码不匹配，则弹出Toast提示。
	- 点击CLEAR按钮后，清除密码输入框的内容。

2.文件编辑Activity：

* 界面底部有三个按钮，高度一致，顶对齐，按钮水平均匀分布，三个按钮上方除ActionBar和StatusBar之外的全部空间由一个EditText占据（保留margin）。EditText内的文字竖直方向置顶，左对齐。
* 在编辑区域输入任意内容，点击SAVE按钮后能保存到指定文件（文件名随意）。成功保存后，弹出Toast提示。
* 点击CLEAR按钮，能清空编辑区域的内容。
* 点击LOAD按钮，能够从同一文件导入内容，并显示到编辑框中。若成功导入，则弹出Toast提示。若读取文件过程中出现异常（如文件不存在），则弹出Toast提示。

3.特殊要求：进入文件编辑Activity后，若点击返回按钮，则直接返回Home界面，不再返回密码输入Activity。

---

## 三、课堂实验结果
### (1)实验截图

- 首次进入，呈现创建密码界面：

  <img src="https://gitee.com/chenyn227/PersonalProject3/raw/master/report/Thursday/16340041ChenYanan/week09/img/Screenshot_1542278151.png" width=400px>

- 若密码为空，弹出Toast提示：

  <img src="https://gitee.com/chenyn227/PersonalProject3/raw/master/report/Thursday/16340041ChenYanan/week09/img/Screenshot_1542278177.png" width=400px>

- 若密码不匹配，弹出Toast提示：

  <img src="https://gitee.com/chenyn227/PersonalProject3/raw/master/report/Thursday/16340041ChenYanan/week09/img/Screenshot_1542278190.png" width=400px>

- 退出后第二次进入呈现输入密码界面：

  <img src="https://gitee.com/chenyn227/PersonalProject3/raw/master/report/Thursday/16340041ChenYanan/week09/img/Screenshot_1542278151.png" width=400px>

- 若密码不正确，弹出Toast提示：

  <img src="https://gitee.com/chenyn227/PersonalProject3/raw/master/report/Thursday/16340041ChenYanan/week09/img/Screenshot_1542278273.png" width=400px>

- 文件加载失败，弹出Toast提示：

  <img src="https://gitee.com/chenyn227/PersonalProject3/raw/master/report/Thursday/16340041ChenYanan/week09/img/Screenshot_1542278221.png" width=400px>

- 成功保存文件，弹出Toast提示：

  <img src="https://gitee.com/chenyn227/PersonalProject3/raw/master/report/Thursday/16340041ChenYanan/week09/img/Screenshot_1542278252.png" width=400px>

- 成功导入文件，弹出Toast提示：

  <img src="https://gitee.com/chenyn227/PersonalProject3/raw/master/report/Thursday/16340041ChenYanan/week09/img/Screenshot_1542278260.png" width=400px>

### (2)实验步骤以及关键代码

#### 1.布局文件：

- 完成两个布局文件的编写；其中密码输入`activity_main.xml`使用了`RelativeLayout`布局，在文件编写布局`activity_file_editor.xml`中，由于这里要控制`EditText`占据除三个按钮之外的屏幕空间，所以我们使用`LinearLayout`布局，并将`EditText`的`layout_weight`属性设置为1，且文本要左对齐，所以设置`gravity`属性为`left`：

    ```xml
    <EditText
        android:layout_height="0dp"
        android:layout_weight="1"
        android:gravity="left" />
    ```

#### 2.使用SharedPreferences保存密码：

`SharedPreferences` 类提供了一个通用框架，以便我们能够保存和检索原始数据类型的永久性键值对，此数据可以跨多个用户会话永久保留。在本项目中我们使用`getSharedPreferences()`方法获取应用的 `SharedPreferences` 对象；

- 写入值：

  ```java
  //save password
  SharedPreferences pwSharedPref = getSharedPreferences(PW_PREFS_NAME, 0);
  SharedPreferences.Editor pwEditor = pwSharedPref.edit();
  pwEditor.putString("password", confirmPwText.getText().toString());
  pwEditor.commit();
  Intent intent = new Intent(getApplicationContext(), FileEditorActivity.class);
  startActivity(intent);
  ```

- 读取值：

  ```java
  //get sharedPreferences
  SharedPreferences pwSharedPref = getSharedPreferences(PW_PREFS_NAME,0);
  String password = pwSharedPref.getString("password", "defValue");
  if (!confirmPwText.getText().toString().equals(password)) {
      Toast.makeText(getApplicationContext(), "Invalid Password", Toast.LENGTH_SHORT).show();
  } else {
      Intent intent = new Intent(getApplicationContext(), FileEditorActivity.class);
      startActivity(intent);
  }
  ```

- 在密码输入.java文件中我们要判断该应用是否第一次启动，这里我们设置一个`Boolean `值`isFirstStart`用来作为判断：

  ```java
  //if fisrt start
  protected void ifFirstStart() {
      SharedPreferences pwSharedPref = getSharedPreferences(PW_PREFS_NAME,0);
      String password = pwSharedPref.getString("password", "defValue");
      if (password.equals("defValue")) {
          isFirstStart = true;
      } else {
          isFirstStart = false;
      }
  }
  ```

#### 3.使用内部存储保存文本输入

- 创建私有文件并写入到内部存储：

  ```java
  //save file
  try (FileOutputStream fos = openFileOutput(MYFILENAME, Context.MODE_PRIVATE)) {
      fos.write(inputText.getText().toString().getBytes());
      fos.close();
      Toast.makeText(getApplicationContext(), "Save successfully.", Toast.LENGTH_SHORT).show();
      Log.i("TAG", "Successfully saved file.");
  } catch (IOException ex) {
      Log.e("TAG", "Fail to save file.");
  }
  ```

- 从内部存储读取文件：

  ```java
  //load file
  try (FileInputStream fis = openFileInput(MYFILENAME)) {
      byte[] contents = new byte[fis.available()];
      fis.read(contents);
      inputText.setText(new String(contents));
      Toast.makeText(getApplicationContext(), "Load successfully.", Toast.LENGTH_SHORT).show();
      fis.close();
  } catch (IOException ex) {
      Toast.makeText(getApplicationContext(), "Fail to load file.", Toast.LENGTH_SHORT).show();
      Log.e("TAG", "Fail to read file.");
  }
  ```

- 除此之外，在进入文件编辑Activity后，要点击返回按钮直接返回Home界面，我们需要在`AndroidManifest.xml` 中设置` noHistory` 属性：

  ```xml
  <activity android:name=".MainActivity" android:noHistory="true">
  ```

### (3)实验遇到的困难以及解决思路

1.除第一次启动应用外，其他启动应用仍然进入输入两次密码界面：

这里是因为对`getString`方法` defValue `参数理解错误引起的，在给定的 key 不存在时，`SharedPreferences` 会直接返回` defValue `这个默认值，修改后如下所示：

```java
SharedPreferences pwSharedPref = getSharedPreferences(PW_PREFS_NAME,0);
String password = pwSharedPref.getString("password", "defValue");
if (password.equals("defValue")) {
    isFirstStart = true;
} else {
    isFirstStart = false;
}
```

---

2.正确读取保存的文件后，`load`仍然不显示：

这是因为在读取文件后，并没有将读取到的`byte[]`转化成为字符串并在`EditTExt`显示出来：

```java
byte[] contents = new byte[fis.available()];
fis.read(contents);
inputText.setText(new String(contents));
```

## 四、实验思考及感想

`Internal Storage`和`External Storage`的区别：

默认情况下，保存到内部存储的文件是应用的私有文件，其他应用（和用户）不能访问这些文件。 当用户卸载应用时，这些文件也会被移除；

保存到外部存储的文件是全局可读取文件，而且，在计算机上启用 USB 大容量存储以传输文件后，可由用户修改这些文件。

---


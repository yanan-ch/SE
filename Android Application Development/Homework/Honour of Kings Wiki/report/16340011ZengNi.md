# 中山大学数据科学与计算机学院本科生实验报告

## （2018年秋季学期）
| 课程名称 | 手机平台应用开发 |   任课老师   |      郑贵锋       |
| :------: | :--------------: | :----------: | :---------------: |
|   年级   |       16级       | 专业（方向） | 软件工程-数字媒体 |
|   学号   |     16340011     |     姓名     |       曾妮        |
|   电话   |   17328304260    |    Email     |  st7120@163.com   |
---

## 一、实验题目
期中项目：王者荣耀英雄大全

---

## 二、本人实现内容
内容：ListView的自定义Adaptor的实现，以及帮助在最后整合代码时debug和修改代码。

---

## 三、课堂实验结果

### (1)实验步骤以及关键代码

自定义Adaptor的实现，在第一次作业的时候可能会比较困难，但在经过多次实验后其实套用模板还是比较轻松的。

首先声明Adaptor，其中保存了list和数据库db。

```java
public class MyAdaptor extends BaseAdapter {
    private List<Herolist> list;
    private LayoutInflater layoutInflater;
    private HeroDataBase db;
    ...
}
```

构造函数中，添加context信息和数据库，并且从数据库初始化list。

````java
public MyAdaptor(Context context, HeroDataBase initDB) {
    layoutInflater = LayoutInflater.from(context);
    db = initDB;
    list = db.getAllComments();
}
````

同数据库相关的添加和删除item函数，实现起来十分简单。

```java
public void removeItem(int i) {
    db.deleteHero(list.get(i).getName());
    list.remove(i);
    notifyDataSetChanged();
}

public void addItem(Herolist hero) {
    if(list != null && hero!= null){
        list.add(hero);
        notifyDataSetChanged();
    }
    db.insertHero(hero);
}
```

Adaptor中最关键的部分就是getView这个函数了，要实现的功能是，为ViewHolder初始化赋值，以及通过list更改相应view的相关的值。

```java
@Override
public View getView(int i, View view, ViewGroup viewGroup) {
    // 新声明一个View变量和ViewHoleder变量,ViewHolder类在下面定义。
    View convertView;
    ViewHolder viewHolder;
    // 当view为空时才加载布局，否则，直接修改内容
    if (view == null) {
        // 通过inflate的方法加载布局，context需要在使用这个Adapter的Activity中传入。
        view = layoutInflater.inflate(R.layout.item, null);
        viewHolder = new ViewHolder();
        viewHolder.heroName = (TextView) view.findViewById(R.id.heroName);
        viewHolder.heroPosition = (TextView) view.findViewById(R.id.heroPosition);
        viewHolder.head = (ImageView) view.findViewById(R.id.head);
        convertView = view;
        convertView.setTag(viewHolder); // 用setTag方法将处理好的viewHolder放入view中
    } else { // 否则，让convertView等于view，然后从中取出ViewHolder即可
        convertView = view;
        viewHolder = (ViewHolder) convertView.getTag();
    }
    // 从viewHolder中取出对应的对象，然后赋值给他们
    viewHolder.heroName.setText(list.get(i).getName());
    viewHolder.heroPosition.setText(list.get(i).getPosition());
    viewHolder.head.setImageURI(Uri.parse(list.get(i).getDefaultImage()));

    // 将这个处理好的view返回
    return convertView;
}
```

本次的ViewHolder中只有三个值，存储了英雄名字，英雄位置，和英雄头像。

```java
private class ViewHolder {
    public TextView heroName;
    public TextView heroPosition;
    public ImageView head;
}
```



### (2)实验遇到的困难以及解决思路

1. 可以说是第一次使用git进行团队合作，大家的很多操作都不太规范，很多时候完成的代码没有通过合并分支来互相获取，而是直接在聊天工具上相互发送，导致由于版本问题最后大家pr时无法自动合并，不得不回退一些版本重新来过，也算是一次经验教训。

2. 有关图片的命名，刚开始使用的中文命名，导致无法获取，后来又改成了带大写的拼音，也是不能使用的，但是重新改过后再push到gitee上，发现图片名称没有任何改变，这才知道windows的git对文件大小写不敏感。

3. 在别的组员处可以成功运行的程序，我的AS中build出错，报告找不到这个组件com.android.tools.lint:lint-gradle-api:26.2.1，查阅资料后发现，虽然部分情况下，用了阿里云的源之后应该就不需要再使用到谷歌的源了，但是仍然应该保留`google()`和`jcenter()`，防止遗漏。

4. 在对各种intent跳转和接收进行处理的时候，很重要的一点就是如果要判断某个key的值是什么来做相应的操作，那么一定要在跳转到该Activity的所有intent的extra的bundle中添加该值，不然就报错在null object上使用equals函数，导致程序闪退。

   比如我们想要的详情界面判断一个key为"add"的值是"true"还是"false"时，在详情界面的onCreate中使用了以下代码

   ```java
   if (getIntent().getExtras().getString("add").equals("true")) { 
    //...
   }
   ```

   那么，在从主页面跳转到该界面，以及从通知点进该界面，和Widget进入该界面的，所有的intent中的bundle中都要添加"add"这个key值。

5. 刚开始组员错误是使用了`setResult()`来试图实现`startActivity()`的功能，在某些情况下居然真的能成功，但是其他情况一直报错，后来更改回来之后就没问题了。查阅这些函数的区别如下：

   > `startActivity() `仅仅是跳转到目标页面，若是想跳回当前页面，则必须再使用一次`startActivity()`。
   > `startActivityForResult() `可以一次性完成这项任务，当程序执行到这段代码的时候，假若从Activity1跳转到下一个Activity2，在Activity2中能够使用`setResult()`这个函数，之后调用`finish()`方法以后，程序会自动跳转回Activity1，并调用前一个Activity1中的`onActivityResult( )`方法。

6. 当对数据库重复插入属性时，由于primary key相同，会导致插入报错。这里必须理清一点有关listview和数据库的操作，在对list进行增删查改的操作时，应当由Activity中绑定相应的listview的Adaptor，而对数据库的所有操作都应在Adaptor中实现，不应该在Activity中执行了Adaptor.addItem后又多执行db.insert，以及，由于使用了EventBus，所以增加的部分直接用EventBus的post，并在订阅方的onMessageEvent中添加。总之，不要重复添加。

---

## 四、实验思考及感想
期中项目整合了以前学过的知识，虽然最后做出来app其实逻辑上有点奇怪，但是也算是实现了我们想要实现的效果。在完成过程中，明显感觉到有些知识已经略有遗忘，导致了很多神奇的错误，也方便我们真正回忆并加深对相应知识的理解。

合并大家的代码的过程花费的时间比我们想象中要多，大家的习惯都不太一样，不同人的代码看起来也比较费力，有些错误也是比较难发现，但是大家合力一起看代码的时候总是比一个人默默地烦恼要让人更有干劲。大部分的错误其实可能都是细节上的错误，比如大家写代码的习惯不一样导致了不匹配啊，沟通不够导致的一些函数的功能的偏差啊，但是最后一起合力完成的时候还是很令人高兴的。

---

#### 作业要求
* 命名要求：学号_姓名_实验编号，例如12345678_张三_lab1.md
* 实验报告提交格式为md
* 实验内容不允许抄袭，我们要进行代码相似度对比。如发现抄袭，按0分处理